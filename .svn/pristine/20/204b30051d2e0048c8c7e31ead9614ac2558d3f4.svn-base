<div class="main-content">
    <div id="addUser" class="popLayer" >
        <div class="breadcrumbs">
            <ul class="breadcrumb">
                <li>标记</li>
            </ul>
            <!-- .breadcrumb -->
            <span class="floatRig closePop">关闭</span>
        </div>
        <div class="col-sm-12" style="height: 260px">
            <div class="row">
                <div class="col-xs-win">
                    <!-- PAGE CONTENT BEGINS -->
                    <form style="position:relative;margin-top:20px;" id="addUser_form" class="form-horizontal" role="form">



                        <div class="space-4"></div>


                        <div class="form-group" style="height: 160px">



                        </div>


                        <div class="space-4"></div>

                        <!-- <input type="hidden" name="id" value="{$template_data['id']}" /> -->
                        <div class="clearfix form-actions">
                            <div>
                                <button class="btn btn-info" type="submit">
                                    <i class="icon-ok bigger-110"></i>
                                    确定
                                </button>



                            </div>
                        </div>
                    </form>
                </div>
                <!-- /.col -->
            </div>
            <!-- /.row -->
        </div>
    </div>

    <div id="ignore" class="popLayer" >
        <div class="breadcrumbs">
            <ul class="breadcrumb">
                <li>忽略</li>
            </ul>
            <!-- .breadcrumb -->
            <span class="floatRig closePop">关闭</span>
        </div>
        <div class="col-sm-12" style="height: 260px">
            <div class="row">
                <div class="col-xs-win">
                    <!-- PAGE CONTENT BEGINS -->
                    <form style="position:relative;margin-top:20px;" id="ignore_form" class="form-horizontal" role="form">
                        <div class="space-4"></div>
                        <div class="form-group" style="height: 160px">
                                <!--<h3>确定要忽略吗?</h3>-->
                        </div>


                        <div class="space-4"></div>
                        <div class="clearfix form-actions">
                            <div>
                                <button class="btn btn-info" type="submit">
                                    <i class="icon-ok bigger-110"></i>
                                    确定
                                </button>
                                <!--<button class="btn" type="reset">
                                    <i class="icon-undo bigger-110"></i>
                                    取消
                                </button>-->



                            </div>
                        </div>
                    </form>
                </div>
                <!-- /.col -->
            </div>
            <!-- /.row -->
        </div>
    </div>

    <div class="breadcrumbs" id="breadcrumbs">
        <script type="text/javascript">
            try {
                ace.settings.check('breadcrumbs', 'fixed')
            } catch (e) {
            }
        </script>

        <ul class="breadcrumb">
            <li>
                紧急事件
            </li>
            <!--<li class="active">紧急事件</li>-->
        </ul>
        <!-- .breadcrumb -->
        <!-- #nav-search -->
    </div>

        <div class="col-sm-12">
            <div class="row">
                <div class="col-xs-12">
                    <div class="formArea marT10" >
                        <div class="formTextList">
                            <label class="floatLeft">时间：</label>
                            <div class="input-group w300 floatLeft" style="width:281px; text-indent:0px;">
			                    <span class="input-group-addon">
                                    <i class="icon-calendar bigger-110"></i>
			                     </span><input class="form-control date-range-picker" type="text" name="da1" data-date-format="YYYY-MM-DD"  id="id-date-range-picker-1"/>
                            </div>
                        </div>
                        <!--<div class="clearBoth"></div>-->
                        <a id="kSearch1" class="btn btn-primary">查询</a>
                    </div>
                    
                    <div class="chartBox marT10" style="position: relative">
                        <div class="aptBox aptBoxW4 aptBoxH3 boxShadowjc" >
                            <div id="container" style=" width:97%;height:100%;margin: auto"></div>
                        </div>

                        <div class="aptBox aptBoxW6 aptBoxH3 marL10 boxShadowjc" >
                            <div id="container2" style=" width: 98%;height:100%;" ></div>
                        </div>

                        <!--30天紧急事件趋势图的翻页-->
                        <div class=" aptBoxW6 " style="position: absolute;right: 1px;bottom: 40px">
                            <a href='#' onclick="jump(1)" style="position: absolute;top: 2px;left: 54px" title="查看上一周期" >
                                <i class="icon-caret-left icon-2x"></i>
                            </a>

                            <a href='#' onclick="jump(2)"  style="position: absolute;top: 2px;right: 12px" title="查看下一周期">
                                <i class="icon-caret-right icon-2x" ></i>
                            </a>
                        </div>
                        <div class="clearBoth"></div>
                    </div>


                    <!-- 表格的筛选栏-->
                    <div class="formArea marT10">
                        <div class="formTextList">
                            <label class="floatLeft">时间：</label>
                            <div class="input-group w300 floatLeft" style="width:281px; text-indent:0px;">
	                        <span class="input-group-addon">
                                <i class="icon-calendar bigger-110"></i>
	                        </span>
                                <input class="form-control date-range-picker" type="text" name="da2" data-date-format="YYYY-MM-DD" id="id-date-range-picker-2" />
                            </div>
                        </div>
                        <div class="formTextList">
                            <label class="floatLeft">关键字：</label>
                            <input type="text" name="keyword" id="keyword" class="floatLeft">
                            <!--</div>-->

                        </div>
                        <a id="kSearch2" class="btn btn-primary">查询</a>


                        <p class="atpTypeList">类型：
                             <a href="javascript:;" class="types sel" data='' >全部(<span>18</span>)</a>
                            <a href="javascript:;" class="types" data='sqlInject' >SQL注入成功(<span>2</span>)</a>
                            <a href="javascript:;" class="types" data='chickenBehave'>鸡肉行为(<span>0</span>)</a>
                            <a href="javascript:;" class="types" data='wormVirus'>蠕虫病毒(<span>2</span>)</a>
                            <a href="javascript:;" class="types" data='trojanBack'>木马回连(<span>1</span>)</a>
                            <a href="javascript:;" class="types" data='ddos'>DDoS(<span>3</span>)</a>
                            <a href="javascript:;" class="types" data='代码/命令执行'>代码/命令执行(<span>6</span>)</a>
                            <a href="javascript:;" class="types" data='非正常登录'>非正常登录(<span>0</span>)</a>
                            <a href="javascript:;" class="types" data='异常网络连接'>异常网络连接(<span>3</span>)</a>
                            <a href="javascript:;" class="types" data='UnlicenseDownload'>未授权下载(<span>0</span>)</a>
                            <a href="javascript:;" class="types" data='webshell'>webshell(<span>1</span>)</a><!-- -->
                        </p>
                        <div class="clearBoth"></div>
                    </div>

                    <div class="aptTable span10 marT10 tableShow boxShadowjc">
                        <div class="aptListBtnGroup"><h4>紧急事件详情</h4></div>
                        <table id="reportTable">
                        </table>
                    </div>
                </div>
            </div>
        </div>
</div>
<script>
    $(document).on("click",".sign",function(){
//        alert(1);
        $("#addUser").show();
        $("#fade").show();
        return false
    });
    $('#ignore_form').submit(function(e){
        e.stopPropagation();
        e.preventDefault();
        $("#addUser").hide();
        $("#ignore").hide();
        $("#fade").hide();
        $.ajax({
            type: "POST",
            url: "__URL__/user_add",
            data: data,
            dataType: "json",
            success:function(data){

            }
        });

    })
    $('#addUser_form').submit(function(e){
        e.stopPropagation();
        e.preventDefault();
        $("#addUser").hide();
        $("#delUser").hide();
        $("#fade").hide();
            $.ajax({
                type: "POST",
                url: "__URL__/user_add",
                data: data,
                dataType: "json",
                success:function(data){

                }
            });

    })
    $(".closePop").css("cursor", "pointer").click(function () {
        $("#addUser").hide();
        $("#ignore").hide();
//        $("#editeUser").hide();
        $("#fade").hide();
        $(":checked").attr('checked',false);
    });

    $(document).on("click",".ignore",function(){
        $("#ignore").show();
        $("#fade").show();
        return false
    });
    $('#keyword').attr('value',getParam("keyword"));
    $('#id-date-range-picker-1').attr('value',URLdecode(getParam("da1")));
    $('#id-date-range-picker-2').attr('value',URLdecode(getParam("da2")));

    function URLdecode(sStr){
       return sStr.replace(/\+/g,' ').replace(/\%2F/g,'\/').replace(/\%20/g,''); 
    }

    function getParam(paramName)
    {
        paramValue = "";
        isFound = false;
        if (this.location.search.indexOf("?") == 0 && this.location.search.indexOf("=")>1)
        {
            arrSource = this.location.search.substring(1,this.location.search.length).split("&");
            i = 0;
            while (i < arrSource.length && !isFound)
            {
                if (arrSource[i].indexOf("=") > 0)
                {
                    if (arrSource[i].split("=")[0].toLowerCase()==paramName.toLowerCase())
                    {
                        paramValue = arrSource[i].split("=")[1];
                        isFound = true;
                    }
                }
                i++;
            }
        }
        return paramValue;
    }
</script>
<!--初始化全局日期-->
<script>
    //获取时间方法
    Date.prototype.Format = function (fmt) {
        var o = {
            "M+": this.getMonth() + 1, //月份
            "d+": this.getDate() //日
        };
        if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        for (var k in o)
            if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        return fmt;
    }
    //获取当前日期
    var endTime= new Date().Format("MM/dd/yyyy");//Format("输入你想要的时间格式:yyyy-MM-dd,yyyyMMdd")
    //结束时间
    var date = new Date();//获取当前时间
    date.setDate(date.getDate()-29);//设置天数 30 天
    var starTime = date.Format("MM/dd/yyyy"); //减完30天以后的时间
    date1=$('input[name="da1"]').val(starTime+" - "+endTime)
</script>
<script>
//    表格时间范围的限制name="da2"
$('input[name="da2"]').on('change',function(){
//    上面日期的分割
    var date1=$('input[name="da1"]').val().split('-');
//    格式化全局日期的起止时间
    var timeS1=date1[0].split('/');
    timeS1.unshift(timeS1[2]);timeS1.pop();timeS1= timeS1.join('/');
    var timeT1=date1[1].split('/');
    timeT1.unshift(timeT1[2]);
    timeT1.pop();
    timeT1= timeT1.join('/');
//格式化表格日期的起止时间
    var date2=$('input[name="da2"]').val().split('-');
    var timeS2=date2[0].split('/');
    timeS2.unshift(timeS2[2]);
    timeS2.pop();
    timeS2= timeS2.join('/');
    var timeT2=date2[1].split('/');
    timeT2.unshift(timeT2[2]);
    timeT2.pop();
    timeT2= timeT2.join('/');
    var dateS1 = new Date(timeS1);
    var dateS2 = new Date(timeS2);
    var dateT1 = new Date(timeT1);
    var dateT2 = new Date(timeT2);
//获取上面时间框的时间
    var date=$('input[name="da1"]').val()
    if(!(dateS1-dateS2<=0&&dateT1-dateT2>=0)){
        layer.alert('请选择'+date+'之间的时间段');
        date2=$('input[name="da2"]').val("");
    }
})
    jQuery(function ($) {
        $('.date-range-picker').daterangepicker({
                    startDate: moment().subtract(29, 'days'),
                    endDate: moment(),
                    maxDate : moment(),
                    locale : {
                        applyLabel: '提交',
                        cancelLabel: '取消',
                        fromLabel: '开始时间',
                        toLabel: '结束时间',
                        weekLabel: 'W',
                        customRangeLabel: 'Custom Range',
                        daysOfWeek: ['日', '一', '二', '三', '四', '五','六'],
                        monthNames: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'],
                        firstDay: moment.localeData()._week.dow
                    },
//                    startDate: moment().startOf('day'),
//                    minValidDate: '315507600000000000000000', //最小可用时间，控制日期选择器的可选力度
                    dateLimit : {
                        day : 29
                    },
                    timePickerIncrement : 1440, //时间的增量，单位为分钟
                    language: 'cn',}
        ).prev().on(ace.click_event, function () {
                    $(this).next().focus();
                });
    })
var count=0;
function jump(v){
    var date1=$('input[name="da1"]').val().split('-');
    var dateS1 = new Date(date1[1]);
    var dateS0 = new Date(date1[0]);
    var cha=(dateS1-dateS0)/86400000+1;
    if(v==1){
        count++;
        if(count>(cha/10)-1){
            count=Math.ceil(cha/10)-1;
        }
        chart2(FormatDate (count*10));
    }else{
        count--;
        if(count<0){
            count=0
        }
        chart2(FormatDate (count*10));
    }

   /* $.ajax({
        url: '__URL__/indexzhutu',
        type: 'GET',
        async: false,
        dataType: 'json',
        data: {'sign':v},
        success:function(data){
            chart2();
        }
    })*/
}

</script>
<!--柱图时间轴的翻页-->
<script>
    var v=0;
    function FormatDate (v) {
        var dateArr=[];
        //<!--获取上面时间框中的时间-->
        var date1=$('input[name="da1"]').val().split('-');
//    格式化全局日期的结止时间
        var dateS1 = new Date(date1[1]);
        //    格式化全局日期的开始时间
        var dateS0 = new Date(date1[0]);
        for(var i=0;i<10;i++){
            var lastDate = new Date(dateS1 - 86400000*(i+v))
            if(lastDate<dateS0){
            }else{
                var lastDate2=(lastDate.getMonth()+1)+"-"+lastDate.getDate();
                dateArr.push(lastDate2)
            }
        }
        dateArr= dateArr.reverse()
        return dateArr;
    }
</script>
<script>
    var chart1=function(data){
        $('#container').highcharts({
            colors: ['#c63012', '#ea7f0c', '#cbf621', '#7798BF', '#aaeeee', '#ff0066', '#eeaaee',
                '#55BF3B', '#DF5353', '#7798BF', '#aaeeee'
            ],
            chart:{
                backgroundColor: '#fefefe',
                type: 'pie',
                options3d: {
                    enabled: true,
                    alpha: 70,
                    beta: 0
                },
            },
            title: {
                text: '紧急事件分布',
                y:28
            },
            credits:{
                enabled:false // 禁用版权信息
            },
            tooltip: {
                pointFormat: '攻击占比: <b>{point.percentage:.1f}%</b><br>'+'{series.name}: <b>{point.y}</b>'
            },
            exporting: {
                enabled: false
            },
            plotOptions: {
                pie: {
                    allowPointSelect: true,
                    cursor: 'pointer',
                    depth: 25,
                    dataLabels: {
                        enabled: true,
                        //format: '{point.name}'
                        format: '<b>{point.name}</b>',
                        style: {
                            color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                        }
                    },
                }
            },
            series: [{
                type: 'pie',
                name: '攻击数',
                data: [['SQL注入成功',2],['DDoS',3],['代码/命令执行',6],['异常网络连接',3],['其他',4]]
            }]
        });
    }
        var chart2=function(arr){
            $('#container2').highcharts({
                chart: {
                    type: 'column'
                },
                title: {
                    text: '告警分析趋势图',
                    y:28
                },
                credits:{
                    enabled:false // 禁用版权信息
                },
                xAxis: {
                    categories: arr
//                    xAxis: {
                       /* categories: ['2-1', '2-2', '2-3', '2-4', '2-5','2-6', '2-7', '2-8', '2-9', '2-10']*/
//                    },
                   /* type: 'category',
                    labels: {
                        style: {
                            fontSize: '14px',
                            fontFamily: 'Verdana, sans-serif'
                        }
                    },*/
                },
                yAxis: {
                    min: 0,
                    title: {
                        text: '数量(个)'
                    }
                },
                legend: {
                    enabled: false
                },

                tooltip: {
                    formatter: function () {
                        return '<b>' + this.x + '</b><br/>' +
                                '告警类别: ' + this.series.name + '<br/>' +
                                '个数: ' + this.y;
                    }
                },
                plotOptions: {
                    column: {
                        stacking: 'normal',
                        pointPadding: 0.2,
                        borderWidth: 0,
                        pointWidth: 30
                    }
                },
                series: [{
                    name: 'SQL注入',
                    color:'#9DC0DC',
                    data: [
                        [20],[3],[0],[1],[2],[0], [5],[3],
                        [1],
                        [2]
                    ]
                }, {
                    name: '非正常登陆',
                    color:'#FEDC57',
                    data: [ [2],[3],[0],[1],[2],[0], [5],[3],
                        [1],
                        [2]
                    ]
                }, {
                    name: '鸡肉行为',
                    color:'#A7CC3E',
                    data: [ [2],[3],[0],[1],[2],[0], [5],[3],
                        [1],
                        [2]
                    ]
                }]
            });
        };

    //当左侧菜单栏显示或隐藏时图表重绘
    $('.icon-double-angle-left').click(function(){
        if($('.col-xs-12').css("width")!=$('.main-content').css("min-width")){
            if($('#sidebar-collapse i').attr('class')=='icon-double-angle-left'){

                setTimeout(function(){
                    $('#container2').highcharts().reflow();
                },1)
            }else{
                setTimeout(function(){
//                    $('#container2').css("width",$('#container2').css("width"))
                    $('#container2').highcharts().reflow();
                },1)
            }

            $('#container2').highcharts().reflow();

        }
    });

    
$(document).ready(function(){
    var da1=$('#id-date-range-picker-1').val();
    $.ajax({
        url: '__URL__/indextu',
        type: 'GET',
        async: false,
        dataType: 'json',
        data:{'da1':da1},
        success:function(data){
            $('#id-date-range-picker-2').val('');
            chart1();
            chart2(FormatDate (v));
        }
    })                                         
});
$(document).ready(function(){
    function operateFormatter(value, row, index) {
            return [
            "<a href='#' class='editIcon marR5 editTable ignore' title='已忽略'><i class='icon-eye-close'></i></a>" +
            "<a href='javascript:;' class='delIcon delTable sign' title='标记'><i class='icon-pushpin'></i></a>"
        ].join('');
    }   
    $('#reportTable').bootstrapTable({
            method: 'get',
            url: '__URL__/indexbiao',
//             search:true,
            cache: false,
//            height: 400,
            striped: true,
            sidePagination:"server",
            pagination: true,
            pageSize: 10,
            pageNumber: 1,
            pageList: [10],
            sortName : 'Time',
            sortOrder : 'desc',
            showColumns: true,
            formatLoadingMessage: function () {
                return "请稍等，正在加载中...";
            },
            formatNoMatches: function () {  //没有匹配的结果
                return '无符合条件的记录';
            },
            queryParams: function (params) {
                var pars = {
                    da1:$('#id-date-range-picker-1').val(),
                    da2:$('#id-date-range-picker-2').val(),
                    urgent_type:$('.urgent_type').attr('data'),
                    keyword:$('#keyword').val(),
                    pagenum:params.offset/params.limit+1,
                    order:params.order,
                    sort:params.sort
                };
                return pars;
            },
            columns: [{
                    field: "Time", 
                    title: "发生时间", 
                    align: "center", 
                    valign: "middle", 
                    sortable: true

                   
                },{
                    field: "UgcType",
                    title: "事件类型", 
                    align: "center", 
                    valign: "middle", 
                    sortable: false,
                },{
                    field: "ServerIp", 
                    title: "受影响资产", 
                    align: "center", 
                    valign: "middle", 
                    sortable: false
                },{
                    field: "Description", 
                    title: "事件描述",
                    align: "center", 
                    valign: "middle", 
                    sortable: false,
                },{
                    field: "id",
                    title: "操作",
                    align: "center",
                    valign: "middle",
                    sortable: false,
                    switchable: false,
                    formatter: operateFormatter
                }],
            data: [/*{
                "Time": "00-E0-4C-3B-7D-2F",
                "UgcType": "百卓2",
                "ServerIp": "11111",
                "Description": "2017-01-01 10:10:10",
            }*/],
            onLoadSuccess:function(data){
                if(!$('#reportTable tbody tr td:nth-child(4)').html()){
                    return ;
                }
                var tdLength=$('#reportTable tbody tr td:nth-child(4)').html().length;
                if(tdLength>=10){
                    $('#reportTable tbody tr td:nth-child(4)').each(function(){
                        //给td设置title属性,并且设置td的完整值.给title属性.
                        $(this).attr("title",$(this).text());
                        //获取td的值,进行截取。赋值给text变量保存.
                        var text=$(this).text().substring(0,10)+"...";
                        //重新为td赋值;
                        $(this).text(text);
                    })
                }
            },
            responseHandler:function(res) {
                var tem = {"total":0,"rows":[]};
                if(res.status){
                    tem.total = res.totalNum;
                    tem.rows = eval(res.data);
                }else{
                    $('#reportTable').bootstrapTable('removeAll');
                }
                return tem;
            },
            onLoadError:function(status,res){
                $('#reportTable').bootstrapTable('removeAll');
                console.log(status,res);
            }
        });
        $(window).resize(function () {
            $('#reportTable').bootstrapTable('resetView');
        });
        $("#kSearch2").click(function(){
            //$('#id-date-range-picker-1').val('');
            var da2 = $('#id-date-range-picker-2').val();
            var keyword = $('#keyword').val();
            $('#reportTable').bootstrapTable('refresh');
        });
        $(".urgent_type").click(function(){
            var da2 = $('#id-date-range-picker-2').val();
            var keyword = $('#keyword').val();
            var urgent_type = $(this).attr('data');
            //console.log($(this).attr('data'));
            $('#reportTable').bootstrapTable('refresh');
        });
        $("#kSearch1").click(function(){
            $('#id-date-range-picker-2').val('');
            $('#keyword').val('');
            var da1 = $('#id-date-range-picker-1').val();
            $.ajax({
                url: '__URL__/indextu',
                type: 'GET',
                async: false,
                dataType: 'json',
                data: {'da1':da1},
                success:function(data){
                    chart1();
                    chart2(FormatDate (v));
                }
            })
            $('#reportTable').bootstrapTable('refresh');
        });
});
    //    类型选择时样式的改变
    $(document).on('click','.atpTypeList a',function(){
        $(this).addClass('sel');
        $(this).siblings('a').removeClass('sel');
    });
</script>
