<div class="main-content">

    <div class="breadcrumbs" id="breadcrumbs">
        <script type="text/javascript">
            try {
                ace.settings.check('breadcrumbs', 'fixed')
            } catch (e) {
            }
        </script>

        <ul class="breadcrumb">
            <li>
                攻击事件
            </li>
            <li class="active">病毒事件</li>
        </ul>
        <!-- .breadcrumb -->
        <!-- #nav-search -->
    </div>
    <div class="tabbable">
                <div class="col-sm-12">
                    <div class="row">
                        <div class="col-xs-12">

                            <div class="formArea">
                                <label class="w70" style="line-height:30px; padding-left:5px; width:65px;">IP地址：</label>
                                <input id="ipinfo" type="text" name="ip" value=""/>
                                <button id="search" class="btn btn-sm btn-primary marL10"><i class="fa fa-search"></i>查询
                                </button>
                            </div>
                            <div id="container" style="float:left;width: 50%;height:300px"></div>
                            <div id="container1" style="float:left;width: 50%;height:300px"></div>

                            <div style="float: left;width: 100%">
                                <div style="float: right;" id="his_change"><a href="__URL__/his_chart?type={$Think.session.type}" class="marL10 btn btn-sm btn-primary">查看历史</a></div>
                                <div id="container_line" style="width:100%;height:300px;margin-left:0px;"></div>
                            </div>
                            <div class="HomeRig" style="width: 100%; margin-top: 20px">

                                <div style="height: 200px;overflow-y: hidden">
                                    <table class="table">
                                        <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>攻击者IP</th>
                                            <th>攻击者区域</th>
                                            <!-- <th>攻击者归属地</th> -->
                                            <th>目标IP</th>
                                            <th>目标区域</th>
                                            <!-- <th>目标归属地</th> -->
                                            <th>平台信息</th>
                                            <th>事件名称</th>
                                            <th>样本名</th>
                                            <th>危害程度</th>
                                            <th>时间</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <volist name="virdata" id="virdata_vo">
                                        <tr class="warning">
                                            <td>{$virdata_vo.id}</td>
                                            <td>{$virdata_vo.attack_ip}</td>
                                            <td>{$virdata_vo.attack_attribution}</td>
                                            <!-- <td>{$virdata_vo.attack_attribution}</td> -->
                                            <td>{$virdata_vo.victim_ip}</td>
                                            <td>{$virdata_vo.victim_attribution}</td>
                                            <!-- <td>{$virdata_vo.victim_attribution}</td> -->
                                            <td><if condition="$virdata_vo['platform'] eq 1">windows<elseif condition="$virdata_vo['platform'] eq 2"/>Linux/Uinux<elseif condition="$virdata_vo['platform'] eq 3"/>Android<elseif condition="$virdata_vo['platform'] eq 4"/>IOS</if></td>
                                            <td>{$virdata_vo.attack_name}</td> 
                                            <td>{$virdata_vo.fname}</td>
                                            <td>{$virdata_vo.hazard_extent_comment}</td>
                                            <td>{$virdata_vo.time_stamp|date="Y-m-d H:i:s",###}</td>
                                        </tr>
                                        </volist>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="dataTables_paginate paging_bootstrap">
                        <ul class="pagination">
                            {$user_show}
                        </ul>
                    </div>
                </div>
    </div>
</div>

<script>
    $('#ipinfo').attr('value',getParam("ip"));
    $('#search').click(function (e) {
        e.stopPropagation();
        e.preventDefault();
        var ip = $('#ipinfo').attr('value');
        window.location.href="__URL__/index_vir?ip="+ip;
    });
    function getParam(paramName)
    {
        paramValue = "";
        isFound = false;
        if (this.location.search.indexOf("?") == 0 && this.location.search.indexOf("=")>1)
        {
            arrSource = this.location.search.substring(1,this.location.search.length).split("&");
            i = 0;
            while (i < arrSource.length && !isFound)
            {
                if (arrSource[i].indexOf("=") > 0)
                {
                    if (arrSource[i].split("=")[0].toLowerCase()==paramName.toLowerCase())
                    {
                        paramValue = arrSource[i].split("=")[1];
                        isFound = true;
                    }
                }
                i++;
            }
        }
        return paramValue;
    }
    Date.prototype.Format = function (fmt) { //author: meizz
        var o = {
            "M+": this.getMonth() + 1, //月份
            "d+": this.getDate(), //日
            "h+": this.getHours(), //小时
            "m+": this.getMinutes(), //分
            "s+": this.getSeconds(), //秒
            "q+": Math.floor((this.getMonth() + 3) / 3), //季度
            "S": this.getMilliseconds() //毫秒
        };
        if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        for (var k in o)
            if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        return fmt;
    }

    $(".form_datetime").val(new Date().Format("yyyy-MM-dd hh:mm"));
    function getWhere() {
        var where = {};
        where.time = $('.date-range-picker').val();
        where.type = $('#type').val();
        where.ip = $('#ipinfo').val();

        return where;
    }
    Highcharts.setOptions({
        lang: {
            resetZoom: '重置',
        }
    });

    jQuery(function ($) {
        $(".form_datetime").datetimepicker({
            autoclose: true,
            language: 'Zh-cn',
            /* startDate: new Date(),*/
            format: 'yyyy-mm-dd hh:ii'
        });
        $('input[name=date-range-picker]').daterangepicker({
                    startDate: moment().subtract(1, 'days'),
                    endDate: moment(),
                    locale: {
                        applyLabel: '提交',
                        cancelLabel: '取消',
                        fromLabel: '开始时间',
                        toLabel: '结束时间',
                        weekLabel: 'W',
                        customRangeLabel: 'Custom Range',
                        daysOfWeek: ['日', '一', '二', '三', '四', '五', '六'],
                        monthNames: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'],
                        firstDay: moment.localeData()._week.dow
                    },
                    language: 'cn',
                    format: 'YYYY/MM/DD'
                }
        ).prev().on(ace.click_event, function () {
                    $(this).next().focus();
                });
        $(function () {
            $('#container').highcharts({
				colors: ['#c63012', '#ea7f0c', '#cbf621', '#7798BF', '#aaeeee', '#ff0066', '#eeaaee',
                '#55BF3B', '#DF5353', '#7798BF', '#aaeeee'
            ],
                chart:{
                    backgroundColor: '#fefefe',
                    type: 'pie',
                    options3d: {
                        enabled: true,
                        alpha: 70,
                        beta: 0
                    },
                },
                title: {
                    text: '病毒事件级别比例饼状图'
                },
                credits:{
                    enabled:false // 禁用版权信息
                },
                tooltip: {
                    pointFormat: '攻击占比: <b>{point.percentage:.1f}%</b><br>'+'{series.name}: <b>{point.y}</b>'
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        depth: 25,
                        dataLabels: {
                            enabled: true,
                            //format: '{point.name}'
                            format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                            style: {
                                color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                            }
                        },
                    }
                },
                series: [{
                    type: 'pie',
                    name: '攻击数',
                    data: {$hazard_count}
                }]
            });
        });
        $(function () {
            $('#container1').highcharts({
                chart: {
                    backgroundColor: '#fefefe',
                    type: 'column'
                },
                title: {
                    text: '病毒事件攻击类别排行 TOP10'
                },
                credits:{
                    enabled:false // 禁用版权信息
                },
                xAxis: {
                    type: 'category',
                    labels: {
                        style: {
                            fontSize: '10px',
                            fontFamily: 'Verdana, sans-serif'
                        }
                    }
                },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.y}</b>'
                },
                plotOptions: {

                },
                series: [{
                    name: '攻击数',
                    data: {$attack_type_count}
                }]
            });
        });
        $(function () {
            var ip = $('#ipinfo').attr('value'),
                timecount = {$time_count},
                time = timecount.time,
                count = timecount.time_count;
            Highcharts.setOptions({
                global: {
                    useUTC: false
                }
            });

            // Create the chart
            Highcharts.stockChart('container_line', {
                chart: {
                    events: {
                        load: function () {

                            // set up the updating of the chart each second
                            var series = this.series[0];
                            setInterval(function () {
                                var x =(new Date()).getTime(),
                                ts = (new Date()).getTime()-5000;
                                $.ajax({
                                    type:'get',
                                    url:'__URL__/getlinechar',
                                    async: false,
                                    data:{'ip':ip,'ts':ts,'te':x,'type':3},
                                    dataType:'json',
                                    success:function(data){
                                        var  y = parseInt(data);
                                        series.addPoint([x, y], true, true);
                                        //console.log(x);console.log(y);
                                    }
                                })
                            }, 5000);
                        }
                    }
                },
                credits:{
                    enabled:false // 禁用版权信息
                },
                yAxis:{
                    opposite:false
                },
                rangeSelector: {
                    buttons: [{
                        count: 1,
                        type: 'minute',
                        text: '分'
                    }, {
                        count: 60,
                        type: 'minute',
                        text: '时'
                    }, {
                        type: 'all',
                        text: '天'
                    }],
                    inputEnabled: false,
                    selected: 0
                },
                navigator: {
                    enabled: false},
                scrollbar: {
                    enabled: true,
                    showFull:true
                },

                title: {
                    text: '实时攻击趋势图'
                },

                exporting: {
                    enabled: false
                },

                series: [{
                    name: 'Random data',
                    data: (function(time,count){
                        var data = [];
                        for (var i = 0; i <= time.length - 1; i++) {
                            data.push([
                                time[i]*1000,
                                count[i]
                            ]);
                        };
                         return data;
                    }(time,count))
                }]
            });

        });
    });

</script>