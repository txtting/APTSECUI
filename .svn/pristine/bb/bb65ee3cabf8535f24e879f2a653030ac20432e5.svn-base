<div class="main-content">
    <div class="breadcrumbs" id="breadcrumbs">
        <script type="text/javascript">
            try {
                ace.settings.check('breadcrumbs', 'fixed')
            } catch (e) {
                
            }
        </script>

        <ul class="breadcrumb">
            <li>
                安全事件
            </li>
            <li class="active">http流量监测</li>
        </ul>
        <!-- .breadcrumb -->
        <!-- #nav-search -->
    </div>
    <div class="col-sm-12">
        <div class="row">
            <div class="col-xs-12" >

                <div class="formArea marT10" >
                     <form  name="search1">
                    <div class="formTextList">
                        <label class="floatLeft">时间：</label>
                        <div class="input-group w300 floatLeft" style="width:281px; text-indent:0px;">
                            <span class="input-group-addon"><i class="icon-calendar bigger-110"></i></span>
                            <input class="form-control date-range-picker" type="text" name="date1" data-date-format="YYYY-MM-DD" value="{$Think.session.date1}" id="id-date-range-picker-1"/>
                        </div>
                    </div>


                        <button onclick="checkaction(0)" class="aptSearchBtn "><i class="fa fa-search"></i>查询</button>
                     </form>
                </div>
            
                <div class="chartBox marT10" style="position: relative; ">
                
                
                <div class="aptBox aptBoxW4 aptBoxH3" >
                <div id="container" style=" width:98%;height:100%;"></div>
                </div>
                
                <div class="aptBox aptBoxW6 aptBoxH3 marL10">
                <div id="container2" style=" width:98%;height:100%;"></div>
                </div>
                    <!--30天http流量攻击趋势图的翻页-->
                    <div class=" aptBoxW6 " style="position: absolute;right: 1px;bottom: 40px">
                        <a href="javascript:jump(up)" style="position: absolute;top: 2px;left: 60px" title="查看上一周期" >
                            <i class="icon-caret-left icon-2x"></i>
                        </a>
                        <!--<h4 style="margin:3px 40%;">3-8——3-17</h4>-->
                        <a href="javascript:jump(down)"  style="position: absolute;top: 2px;right: 7px" title="查看下一周期">
                            <i class="icon-caret-right icon-2x" ></i>
                        </a>
                    </div>
                   <div class="clearBoth"></div>
                </div>
                
                <div class="formArea marT10" id="type" >
                     <form   name="search2">
                         <div class="formTextList">
                             <label class="floatLeft"> 时间：</label>
                             <div class="input-group w300 floatLeft" style="width:281px; text-indent:0px;">
                            <span class="input-group-addon">
                                <i class="icon-calendar bigger-110"></i>
                            </span>
                                 <input class="form-control date-range-picker" type="text" name="date2" data-date-format="YYYY-MM-DD" id="id-date-range-picker-2" value="{$Think.session.date2}" />
                             </div>
                         </div>

                         <div class="formTextList">
                             <label class="floatLeft">关键字：</label>
                             <input type="text" name="username" class="floatLeft">
                         </div>
                         <button class="aptSearchBtn" onclick="checkaction(1)"><i class="fa fa-search" ></i>查询</button>

                     </form>
                    <p class="atpTypeList"> 类型：
                     <a href="javascript:;" class="http_type" data='全部'>全部(<span>0</span>)</a>
                     <a href="javascript:;" class="http_type" data='SQL注入成功'>SQL注入成功(<span>0</span>)</a>
                     <a href="javascript:;" class="http_type" data='XSS攻击'>XSS攻击(<span>0</span>)</a>
                     <a href="javascript:;" class="http_type" data='代码/命令执行'>代码/命令执行(<span>0</span>)</a>
                     <a href="javascript:;" class="http_type" data='本地文件包含'>本地文件包含(<span>0</span>)</a>
                     <a href="javascript:;" class="http_type" data='远程文件包含'>远程文件包含(<span>0</span>)</a>
                     <a href="javascript:;" class="http_type" data='脚本木马'>脚本木马(<span>0</span>)</a>
                     <a href="javascript:;" class="http_type" data='上传漏洞'>上传漏洞(<span>0</span>)</a>
                     <a href="javascript:;" class="http_type" data='路径遍历'>路径遍历(<span>0</span>)</a>
                     <a href="javascript:;" class="http_type" data='拒绝服务'>拒绝服务(<span>0</span>)</a>
                     <a href="javascript:;" class="http_type" data='越权访问'>越权访问(<span>0</span>)</a>
                     <a href="javascript:;" class="http_type" data='CSRF'>CSRF(<span>0</span>)</a>
                     <a href="javascript:;" class="http_type" data='其他'>其他(<span>0</span>)</a>
                 </p>
                </div>
                <div class="aptTable span10 marT10 tableShow">
                    <div class="aptListBtnGroup"><h4>http流量攻击详情</h4></div>
                    <table id="reportTable">
                    </table>

                </div>                
            </div>
            </div>
        </div>
        
    </div>
</div>
<script type="text/javascript">
    $(function () {
        function operateFormatter(value, row, index) {
            return [
                "<a href='#' class='editIcon marR5 editTable' title='编辑'><i class='icon-edit'></i></a><a href='javascript:;' class='delIcon delTable' title='删除' data-toggle='modal' data-target='#mySmModal''><i class='icon-trash'></i></a>"
            ].join('');
        }

        $('#reportTable').bootstrapTable({
            method: 'get',
//            url: '__URL__/indexbiao',
            cache: false,
            striped: true,
//            sidePagination:"server",
            pagination: true,
            pageSize: 10,
            pageNumber: 1,
            pageList: [10],
            sortName : 'Time',
            sortOrder : 'desc',
            showColumns: true,
            columns: [{
                checkbox: true,
            },
                {field: "mac", title: "攻击时间", align: "center", valign: "middle", sortable: false},
                {field: "brand", title: "被攻击应用", align: "center", valign: "middle", sortable: false},
                {field: "cache_ssid", title: "被攻击URL地址", align: "center", valign: "middle", sortable: false},
                {field: "capture_time", title: "请求方式", align: "center", valign: "middle", sortable: false},
                {
                    field: "terminal_field_strength",
                    title: "攻击类型",
                    align: "center",
                    valign: "middle",
                    sortable: false
                },
                {field: "identification_type", title: "攻击IP", align: "center", valign: "middle", sortable: false},
                {field: "certificate_code", title: "攻击状态", align: "center", valign: "middle", sortable: false},
                {
                    field: "place_set",
                    title: "操作",
                    align: "center",
                    valign: "middle",
                    sortable: false,
                    switchable: false,
                    formatter: operateFormatter
                }],
            data: [{
                "mac": "00-E0-4C-3B-7D-2F",
                "brand": "百卓",
                "cache_ssid": "11111",
                "capture_time": "2017-01-01 10:10:10",
                "terminal_field_strength": "22",
                "identification_type": "2",
                "certificate_code": "2",
            }]
        });

        $(window).resize(function () {
            $('#reportTable').bootstrapTable('resetView');
        });
    });
</script>
<!--初始化全局日期-->
<script>
    //获取时间方法
    Date.prototype.Format = function (fmt) {
        var o = {
            "M+": this.getMonth() + 1, //月份
            "d+": this.getDate() //日
        };
        if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        for (var k in o)
            if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        return fmt;
    }
    //获取当前日期
    var endTime= new Date().Format("MM/dd/yyyy");//Format("输入你想要的时间格式:yyyy-MM-dd,yyyyMMdd")
    //结束时间
    var date = new Date();//获取当前时间
    date.setDate(date.getDate()-30);//设置天数 30 天
    var starTime = date.Format("MM/dd/yyyy"); //减完30天以后的时间
    date1=$('input[name="date1"]').val(starTime+" - "+endTime)
</script>
<script>
    //    表格时间范围的限制name="date2"
    $('input[name="date2"]').on('change',function(){
//    上面日期的分割
        var date1=$('input[name="date1"]').val().split('-');
//    格式化全局日期的起止时间
        var timeS1=date1[0].split('/');
        timeS1.unshift(timeS1[2]);timeS1.pop();timeS1= timeS1.join('/');
        var timeT1=date1[1].split('/');
        timeT1.unshift(timeT1[2]);
        timeT1.pop();
        timeT1= timeT1.join('/');
//格式化表格日期的起止时间
        var date2=$('input[name="date2"]').val().split('-');
        var timeS2=date2[0].split('/');
        timeS2.unshift(timeS2[2]);
        timeS2.pop();
        timeS2= timeS2.join('/');
        var timeT2=date2[1].split('/');
        timeT2.unshift(timeT2[2]);
        timeT2.pop();
        timeT2= timeT2.join('/');
        var dateS1 = new Date(timeS1);
        var dateS2 = new Date(timeS2);
        var dateT1 = new Date(timeT1);
        var dateT2 = new Date(timeT2);
        if(!(dateS1-dateS2<=0&&dateT1-dateT2>=0)){
            layer.alert('请选择正确时间')
            date2=$('input[name="date2"]').val("")
        }
    })
    jQuery(function ($) {
        $('.date-range-picker').daterangepicker({
                    startDate: moment().subtract(30, 'days'),
                    endDate: moment(),
                    locale : {
                        applyLabel: '提交',
                        cancelLabel: '取消',
                        fromLabel: '开始时间',
                        toLabel: '结束时间',
                        weekLabel: 'W',
                        customRangeLabel: 'Custom Range',
                        daysOfWeek: ['日', '一', '二', '三', '四', '五','六'],
                        monthNames: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'],
                        firstDay: moment.localeData()._week.dow
                    },
                    dateLimit : {
                        day : 30
                    },
                    timePickerIncrement : 1440, //时间的增量，单位为分钟
                    language: 'cn',}
        ).prev().on(ace.click_event, function () {
                    $(this).next().focus();
                });

    })
    function checkaction(v){
        if(v==0){
            var date1 = $('#id-date-range-picker-1').val();
            //alert(date1);
            $.ajax({
                url: '__URL__/indextubiao',
                type: 'GET',
                async: false,
                dataType: 'json',
                data: {'date1':date1},
                success:function(data){
                    $('#id-date-range-picker-2').val('');
                    chart1();
                    chart2();
                    $('#tbody').html();
                    get_tbody_content(data);
                }
            })
        }else{
            var date1 = $('#id-date-range-picker-1').val();
            var date2 = $('#id-date-range-picker-2').val();
            //alert(date1);
            $.ajax({
                url: '__URL__/indexbiao',
                type: 'GET',
                async: false,
                dataType: 'json',
                data: {'date1':date1,'date2':date2},
                success:function(data){
                    $('#tbody').html();
                    get_tbody_content(data);
                }
            })
        } 
    }
function get_tbody_content(data){
    var content_str = '<tr><td>2017-03-13 10:10:09</td><td>百度</td><td>http://www.baidu.com</td><td>POSST</td><td>-</td><td>110.0.9.22</td><td>-</td><td>未标记</td><td><a href="#" title="忽略"><i class="icon-eye-open" style="color:#F00"></i></a><a href="#" class="marL10" title="标记"><i class="icon-pushpin" style="color:#06F"></i></a></td></tr><tr><td>2017-03-13 10:10:09</td><td>百度</td><td>http://www.baidu.com</td><td>POSST</td><td>-</td><td>110.0.9.22</td><td>-</td><td>未标记</td><td><a href="#" title="忽略"><i class="icon-eye-open" style="color:#F00"></i></a><a href="#" class="marL10" title="标记"><i class="icon-pushpin" style="color:#06F"></i></a></td></tr>';
    /*if (data.source_data) {
        $.each(data.source_data, function(index, value){
            content_str += ' <ul class="alarmWinList" ><li><span class="waper_col">'+value.content +'</span></li><li><span class="waper_col">'+value.source +'</span></li><li><span class="waper_col">'+value.num +'</span></li><li><span class="waper_col"><a href="__APP__/Alarm/alarmList?ids='+value.ids+'&local_roomname='+data.local_roomname+'&alarm_source='+data.alarm_source+'&date='+data.date+'">查看详情</a></span></li></ul>';
        });
    }*/
    $('#tbody').html(content_str) ;
}
$('.http_type').click(function(){
    var date2 = $('#id-date-range-picker-2').val();
    var http_type = $(this).attr('data');
    //alert(http_type);
    $.ajax({
        url: '__URL__/indexbiao',
        type: 'GET',
        async: false,
        dataType: 'json',
        data: {'date2':date2,'http_type':http_type},
        success:function(data){
            $('#tbody').html();
            get_tbody_content(data);
        }
    })
});
function jump(v){
    //var date1 = $('#id-date-range-picker-1').val();
    var sign;
    if(v=='up'){
        sign = 1;
    }else if(v=='down'){
        sign = 2;
    }
    $.ajax({
        url: '__URL__/indexzhutu',
        type: 'GET',
        async: false,
        dataType: 'json',
        data: {'sign':sign},
        success:function(data){
            chart2();
        }
    })
}
</script>
<script type="text/javascript">
var chart1=function(data){
     $('#container').highcharts({
         colors: ['#c63012', '#ea7f0c', '#cbf621', '#7798BF', '#aaeeee', '#ff0066', '#eeaaee',
             '#55BF3B', '#DF5353', '#7798BF', '#aaeeee'
         ],
         chart:{
             backgroundColor: '#fefefe',
             type: 'pie',
             options3d: {
                 enabled: true,
                 alpha: 70,
                 beta: 0
             },
         },
         title: {
             text: 'http流量攻击类型'
         },
         credits:{
             enabled:false // 禁用版权信息
         },
         tooltip: {
             pointFormat: '攻击占比: <b>{point.percentage:.1f}%</b><br>'+'{series.name}: <b>{point.y}</b>'
         },
         exporting: {
             enabled: false
         },
         plotOptions: {
             pie: {
                 allowPointSelect: true,
                 cursor: 'pointer',
                 depth: 25,
                 dataLabels: {
                     enabled: true,
                     //format: '{point.name}'
                     format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                     style: {
                         color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                     }
                 },
             }
         },
         series: [{
             type: 'pie',
             name: '攻击数',
             data: [['SQL注入成功',30],['鸡肉行为',40],['蠕虫病毒',40],['木马回连',20],['DDoS',22],['非正常登陆',14],['其他',10]]

         }]
     });
 }


var chart2=function(data){
    $('#container2').highcharts({
        chart: {
            type: 'column'
        },
        title: {
            text: 'http流量检测攻击趋势图',
//                    x:-20,
//                    y:28
            /*y:28,
             style:{
             fontSize: '14px'}*/

        },
        credits:{
            enabled:false // 禁用版权信息
        },
        xAxis: {
            type: 'category',
            labels: {
                style: {
                    fontSize: '14px',
                    fontFamily: 'Verdana, sans-serif'
                }
            },
        },
        yAxis: {
            min: 0,
            title: {
                text: '数量(个)'
            }
        },
        legend: {
            enabled: false
        },
        tooltip: {
            formatter: function () {
                return '<b>' + this.x + '</b><br/>' +
                        '告警类别: ' + this.series.name + '<br/>' +
                        '个数: ' + this.y;
            }
        },
        plotOptions: {
            column: {
                stacking: 'normal',
                // dataLabels: {
                //     enabled: true
                // }
            }
        },
        series: [{
            name: 'SQL注入',
            data: [
                ['3-8',2],['3-9',3],['3-10',4],['3-11',1],['3-12',2],['3-13',2], ['3-14',5],['3-15',3],
                ['3-16',2],
                ['3-17',2]
            ]
        }, {
            name: '非正常登陆',
            data: [
                ['3-8',2],['3-9',3],['3-10',4],['3-11',1],['3-12',2],['3-13',2], ['3-14',5],['3-15',3],
                ['3-16',2],
                ['3-17',2]
            ]
        }, {
            name: '鸡肉行为',
            data: [
                ['3-8',2],['3-9',3],['3-10',4],['3-11',1],['3-12',2],['3-13',2], ['3-14',5],['3-15',3],
                ['3-16',2],
                ['3-17',2]
            ]
        }]
    });
}

//当左侧菜单栏显示或隐藏时图表重绘
$('.icon-double-angle-left').click(function(){
    if($('.col-xs-12').css("width")!=$('.main-content').css("min-width")){
        if($('#sidebar-collapse i').attr('class')=='icon-double-angle-left'){

            setTimeout(function(){
                $('#container2').highcharts().reflow();
            },1)
        }else{
            setTimeout(function(){
//                    $('#container2').css("width",$('#container2').css("width"))
                $('#container2').highcharts().reflow();
            },1)
        }

        $('#container2').highcharts().reflow();

    }
});
$(document).ready(function(){
    $.ajax({
        url: '__URL__/indextubiao',
        type: 'GET',
        async: false,
        dataType: 'json',
        success:function(data){
//            $('#id-date-range-picker-1').val('');
//            $('#id-date-range-picker-2').val('');
            chart1();
            chart2();
            $('#tbody').html();
            get_tbody_content(data);
        }
    })                                         
}); 
</script>
