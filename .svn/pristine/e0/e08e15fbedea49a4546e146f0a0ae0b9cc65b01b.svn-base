<div class="main-content">
    <div id="addUser" class="popLayer">
        <div class="breadcrumbs">
            <ul class="breadcrumb">
                <li>添加用户</li>
            </ul>
            <!-- .breadcrumb -->
            <span class="floatRig closePop">关闭</span>
        </div>
        <div class="col-sm-12">
            <div class="row">
                <div class="col-xs-win">
                    <!-- PAGE CONTENT BEGINS -->
                    <form style="position:relative;margin-top:20px;" id="addUser_form" class="form-horizontal" role="form">

                        <div class="form-group">
                            <label class="col-sm-3 control-label no-padding-right"> 用户名： </label>

                            <div class="col-sm-9">
                                <input type="text" name="name" placeholder="用户名"  pattern="^\S{1,18}$"  title="请输入1-18位字符" class="col-xs-10 col-sm-5" required/>
                            </div>
                        </div>
                                                    
                        <div class="space-4"></div>

                        <div class="form-group">
                            <label class="col-sm-3 control-label no-padding-right"> 密码：</label>

                            <div class="col-sm-9">
                                <input type="text" name="password" pattern="^\S{6,18}$"  title="请输入6-18位密码" class="col-xs-10 col-sm-5" required/>
                            </div>
                        </div>

                        
                        <div class="space-4"></div>

                        <div class="form-group">
                            <label class="col-sm-3 control-label no-padding-right"> 邮箱：</label>

                            <div class="col-sm-9">
                                <input type="email" name="email" class="col-xs-10 col-sm-5" pattern="^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(.[a-zA-Z0-9_-])+" required/>
                            </div>
                        </div>


                    <div class="space-4"></div>

                        <div class="form-group">

                            <label class="col-sm-3 control-label no-padding-right"> 用户组： </label>

                           <div class="col-sm-9" style="line-height:30px;" id="ischeck">
                                <volist name="group_data" id="group_data_vo" >
                                      <input type="checkbox" name="usergroup[]" value="{$group_data_vo['id']}" style="margin-right:5px;">{$group_data_vo['title']}
                                </volist>
                           </div>
                           
                        </div>
                        
                        <div class="space-4"></div>

                        <!-- <input type="hidden" name="id" value="{$template_data['id']}" /> -->
                        <div class="clearfix form-actions">
                            <div>
                                <button class="btn btn-info" type="submit">
                                    <i class="icon-ok bigger-110"></i>
                                    提交
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <!-- /.col -->
            </div>
            <!-- /.row -->
        </div>
    </div>
    
    <div id="ajaxAlert"  class="popLayer" style="top:100px;left:50%;width: 20%;margin-left:-10%;">
        <div class="breadcrumbs">
            <ul class="breadcrumb">
                <li>
                    提示
                </li>
            </ul>
            <!-- .breadcrumb -->
            <span class="floatRig closePop"></span>
        </div>
            <div class="tipText">
        
            </div>
    </div>

    <div id="editeUser" class="popLayer">
        <div class="breadcrumbs">
            <ul class="breadcrumb">
                <li>编辑用户</li>
            </ul>
            <!-- .breadcrumb -->
            <span class="floatRig closePop">关闭</span>
        </div>
        <div class="col-sm-12">
            <div class="row">
                <div class="col-xs-win">
                    <!-- PAGE CONTENT BEGINS -->
                    <form style="position:relative;margin-top:20px;" id="user_edite_form" class="form-horizontal" role="form">

                        <div class="form-group">
                            <label class="col-sm-3 control-label no-padding-right"> 用户名： </label>

                            <div class="col-sm-9">

                                <input type="text" name="name" id="edite_user" placeholder="用户名" pattern="^\S{1,18}$"  title="请输入小于1-18位字符" class="col-xs-10 col-sm-5"
                                       required/>

                            </div>
                        </div>


                        <div class="space-4"></div>

                        <div class="form-group">
                            <label class="col-sm-3 control-label no-padding-right"> 邮箱： </label>

                            <div class="col-sm-9">

                                <input type="email" name="email" id="edite_email" class="col-xs-10 col-sm-5" pattern="^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(.[a-zA-Z0-9_-])+" required/>

                            </div>
                        </div>
                        <div class="space-4"></div>

                        <div class="form-group">

                            <label class="col-sm-3 control-label no-padding-right"> 用户组： </label>

                           <div class="col-sm-9" style="line-height:30px;" id="userGroup_sel">
                               <volist name="group_data" id="group_data_vo" >
                                      <input type="checkbox"  name="usergroup[]" value="{$group_data_vo['id']}" style="margin-right:5px;">{$group_data_vo['title']}
                                </volist>
                           </div>
                           
                        </div>

                        <div class="space-4"></div>
                        <input type="hidden" id='id' name="id"  />
                        <div class="clearfix form-actions">
                            <div>
                                <button class="btn btn-info user_edite" type="submit">
                                    <i class="icon-ok bigger-110"></i>
                                    提交
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <!-- /.col -->
            </div>
            <!-- /.row -->
        </div>
    </div>
    <div id="delUser" class="popLayer" style="top:100px;left:50%;width: 40%;margin-left:-20%;">
        <div class="breadcrumbs">
            <ul class="breadcrumb">
                <li>
                    删除用户
                </li>
            </ul>
            <!-- .breadcrumb -->
            <span class="floatRig closePop">关闭</span>
        </div>
        <div class="col-sm-12">
            <div class="row">
                <div class="col-xs-win">
                    <!-- PAGE CONTENT BEGINS -->
                    <form style="position:relative;top:20px;" id="user_delete_form" class="form-horizontal" role="form">
                        <div class="form-group">
                            <label class="col-sm-4 control-label no-padding-right"> 确定要删除此用户？ </label>
                        </div>
                        <input type="hidden" id="id"  />
                        <div class="clearfix form-actions">
                            <div>
                                <button class="allusers btn btn-danger" >
                                    <i class="icon-remove  bigger-110 "></i>
                                    删除
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <!-- /.col -->
            </div>
            <!-- /.row -->
        </div>
    </div>
    <div id="fade" class="black_overlay"></div>
    <div class="breadcrumbs" id="breadcrumbs">
        <script type="text/javascript">
            try {
                    ace.settings.check('breadcrumbs', 'fixed')
                } catch (e) {
            }
        </script>

        <ul class="breadcrumb">
            <li>
                权限管理
            </li>
            <li class="active">用户管理</li>
        </ul>
        <!-- .breadcrumb -->
        <!-- #nav-search -->
    </div>
    <div class="col-sm-12">
        <div class="row">
            <div class="col-xs-12">

             <div class="formArea marT10" >
                        <div class="formTextList" style="min-width: 358px">
                            <label class="floatLeft">注册时间：</label>
                            <div class="input-group w300 floatLeft" style="width:281px; text-indent:0px;">
			                    <span class="input-group-addon">
                                    <i class="icon-calendar bigger-110"></i>
			                     </span><input class="form-control date-range-picker" type="text" name="date-range-picker" data-date-format="YYYY-MM-DD"
                                               id="id-date-range-picker-1"/>
                            </div>
                        </div>
                        <div class="formTextList" >
                            <label class="floatLeft">用户组：</label>
                            <select name="usergroup" class="usergroup floatLeft">
                                <option value="">请选择</option>
                                <volist name="group_data" id="group_data_vo" >
                                    <option value="{$group_data_vo['id']}">{$group_data_vo['title']}</option>
                                </volist>
                            </select>
                        </div>
                        <div class="formTextList" >
                            <label class="floatLeft"> 用户名：</label>
                            <input type="text" name="username" class="floatLeft">
                        </div>

                    <a href="javascript:;" class="aptSearchBtn" id="kSearch">查询</a>
                    <div class="clearBoth"></div>
                </div>
                <div class="aptTable span10 marT10  tableShow" style="display: none">
                <div class="aptListBtnGroup" >
                    <input type="checkbox"  id="allCheck" style="position: absolute;top:50px;left:17.5px;z-index: 1">
                    <a href="#" class="" id="userAdd"><i class="icon-plus-sign bigger-120 green"></i>添加</a>
                    <a href="#" class="" id="userDel"><i class="icon-remove  bigger-120 red "></i>批量删除</a>
                </div>

                <table id="reportTable">
                </table>
			</div>
            </div>
            </div>
        </div>

    </div>
</div>

<script>
    $('.usergroup').attr('value',getParam("usergroup"));
    $('.username').attr('value',getParam("username"));
    $('.date-range-picker').attr('value',URLdecode(getParam("date-range-picker")));

    function URLdecode(sStr){
       return sStr.replace(/\+/g,' ').replace(/\%2F/g,'\/').replace(/\%20/g,'');
    }

    function getParam(paramName)
    {
        paramValue = "";
        isFound = false;
        if (this.location.search.indexOf("?") == 0 && this.location.search.indexOf("=")>1)
        {
            arrSource = this.location.search.substring(1,this.location.search.length).split("&");
            i = 0;
            while (i < arrSource.length && !isFound)
            {
                if (arrSource[i].indexOf("=") > 0)
                {
                    if (arrSource[i].split("=")[0].toLowerCase()==paramName.toLowerCase())
                    {
                        paramValue = arrSource[i].split("=")[1];
                        isFound = true;
                    }
                }
                i++;
            }
        }
        return paramValue;
    }

	$(document).on("click","#userAdd",function(){
        $("#addUser").show();
        $("#fade").show();
        return false
    });

    $('#addUser_form').submit(function(e){
        e.stopPropagation();
        e.preventDefault();
        var data = $('#addUser_form').serialize();
        var checkVal= $('#ischeck input').serialize();
        if (checkVal =='') {
                 layer.msg("请选择用户组");
                return false
        }else{

            $.ajax({
                 type: "POST",
                 url: "__URL__/user_add",
                 data: data,
                 dataType: "json",
                success:function(data){
                    if(data.status=='success'){
                        $("#addUser").hide();
                        $("#fade").hide();
                        $('#addUser_form')[0].reset();
                        layer.msg(data.msg);
                        window.location.reload();
                    }else if(data.status=='1'){
                        layer.msg(data.msg);
                    }else{
                        layer.msg(data.msg);
                    }
                }
             });
          }

    })

    $(".closePop").css("cursor", "pointer").click(function () {
        $("#addUser").hide();
        $("#delUser").hide();
        $("#editeUser").hide();
        $("#fade").hide();
        $(":checked").attr('checked',false);
    });

    $(document).on("click",".deleteuser",function(){
        $('#id').val($(this).attr('data'));
        $("#delUser").show();
        $("#fade").show();
        return false;
    });
    $('#user_delete_form').submit(function(e){
        e.stopPropagation();
        e.preventDefault();
        var id=$('#id').val();
        $.ajax({
            url:'__URL__/user_delete',
            type:'POST',
            dataType:'json',
            data:{'id':id},
            success:function(data){
                if(data.status=='success'){
                    $("#delUser").hide();
                    $("#fade").hide();
                    $('#user_delete_form')[0].reset();
                    layer.msg(data.msg);
                    window.location.reload();
                    $(":checked").attr('checked',false);
                }else{
                    $("#delUser").hide();
                    $("#fade").hide();
                    $(":checked").attr('checked',false);
                    layer.msg(data.msg);
                }
            }
        });
    });
	$(document).on("click","#userDel",function(){
        var val=$('#reportTable tbody input:checkbox[type="checkbox"]:checked').map(function(){
            return $(this).val();
        }).get();
        if(val.length<1){
            layer.alert("请选择用户");
            return;
        }
        var ids=[];
        $('.checkBtn').each(function (index, value) {
            if($(this).is(':checked')){
                ids.push($(this).attr('data'));
            }
        });
        ids = ids.join(',');
        $('#id').val(ids);
        $("#delUser").show();
        $("#fade").show();
    });
		$(document).on("click",".editeUser",function(){
            var row = $(this).parents('tr');
            var id = $(this).attr('data');
            $("#edite_user").val(row.children('td:eq(1)').html());
            $("#edite_email").val(row.children('td:eq(3)').html());
            var group_id = [];
            $.ajax({
                type: "POST",
                url: "__URL__/get_usergroup",
                data: {'id':id},
                dataType: "json",
                success: function(data){
                    for (var i = 0; i < data.length; i++) {
                        group_id.push(data[i]['group_id']);
                    }
                    $('#userGroup_sel input').each(function(){
                        id = $(this).val();
                        for(var i=0;i<group_id.length;i++){
                        if (id==group_id[i]) {
                            $(this).attr('checked','checked');
                        }
                        }
                    });
                    $("#editeUser").show();
                    $("#fade").show();
                }
            });
            $('#id').val(id);
            return false
        });
    $('#user_edite_form').submit(function(e){
        e.stopPropagation();
        e.preventDefault();
        var editeUser_data = $('#user_edite_form').serialize();
        var checkVal = $('#userGroup_sel input').serialize();
        if (checkVal =='') {
             layer.msg("请选择用户组");
             return false
        }else{
        $.ajax({
            url:'__URL__/do_user_edite',
            type:'POST',
            dataType:'json',
            data:editeUser_data,
            success:function(data){
                if(data.status=='success'){
                    $("#editeUser").hide();
                    $("#fade").hide();
                    $('#user_edite_form')[0].reset();
                    layer.msg("编辑成功");
                    window.location.reload();
                }else if(data.status=='1'){
                    layer.msg(data.msg);
                }else{
                    layer.msg(data.msg);
                }
            }
        });
    }
    });
    jQuery(function ($) {
        $('input[name=date-range-picker]').daterangepicker({
                    startDate: moment().subtract(1, 'days'),
                    endDate: moment(),
                    locale : {
                        applyLabel: '提交',
                        cancelLabel: '取消',
                        fromLabel: '开始时间',
                        toLabel: '结束时间',
                        weekLabel: 'W',
                        customRangeLabel: 'Custom Range',
                        daysOfWeek: ['日', '一', '二', '三', '四', '五','六'],
                        monthNames: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'],
                        firstDay: moment.localeData()._week.dow
                    },
                    language: 'cn',}
        ).prev().on(ace.click_event, function () {
                    $(this).next().focus();
                });
    })
//点击其他，更新全选
    $(document).on('click', '.checkBtn', function () {
        if($('.checkBtn:not(:checked)').length === 0){
            var is_checked = $(this).prop("checked");
            $('#allCheck').prop("checked", is_checked);
        }else{
            $('#allCheck').prop('checked', false);
        }
    })
    //设置全选，全不选
    $(document).on('click', '#allCheck', function () {
        $('.checkBtn').prop('checked', this.checked);
    });

   $(document).ready(function(){
         function operateFormatter(value, row, index) {
             if(index!==0){
                 return [
                     '<a class="green editeUser" href="javascript:;" data="'+value+'" title="编辑"><i class="icon-pencil bigger-130"></i></a> ' +
                     '<a class="red deleteuser"  href="javascript:;" data="'+value+'" title="删除"><i class="icon-trash bigger-130"></i></a>'
                 ].join('');
             }else{
                 return ['<div class="fht-cell"></div>']
             }
         }
        function userGroupFormatter(value, row, index) {
            var str = "<select style='height: 20px; font-size: 12px;padding: 0px;'>";
            if (value) {
                $.each(value, function(key, val){
                    str += '<option>'+val+'</option>';
                });
            }
            str += "</select>";
            return str;
        }
       function disCheckFormatter(value, row, index) {
//           console.log(row.id);
          if(index!==0){
              var str = "<input type='checkbox' name='items' class='checkBtn' data='"+row.id+"' name='btSelectAll' style='height: 13px; width:13px; padding: 0px;' data-index=";
              str += index+"/><div class='fht-cell'></div>";
          }else{
              str = "<div class='fht-cell'></div>";
          }
           return str;
       }
        $('#reportTable').bootstrapTable({
            method: 'get',
            url: '__URL__/userOk',
            cache: false,
            striped: true,
            sidePagination:"server",
            pagination: true,
            pageSize: 10,
            pageNumber: 1,
            pageList: [10],
            sortName : 'create_time',
            sortOrder : 'desc',
            showColumns: true,
            formatLoadingMessage: function () {
                return "请稍等，正在加载中...";
            },
            formatNoMatches: function () {  //没有匹配的结果
                return '无符合条件的记录';
            },
            queryParams: function (params) {
                var pars = {
                    da1:$('.date-range-picker').val(),
                    username:$('.username').val(),
                    usergroup:$('.usergroup').val(),
                    pagenum:params.offset/params.limit+1,
                    order:params.order,
                    sort:params.sort
                };
                return pars;
            },
            columns: [{
                title:"<div class='fht-cell'></div>",
                formatter:disCheckFormatter,
                align: "center",
                valign: "middle",
                width:'48'
            },{
                field: "user_login", 
                title: "用户名", 
                align: "center", 
                valign: "middle", 
                sortable: false
            },{
                field: 'title',
                title: '用户组',
                valign: 'middle',
                align: 'center',
                sortable: false,
                formatter: userGroupFormatter
            },{
                field: "user_email", 
                title: "邮箱", 
                align: "center", 
                valign: "middle", 
                sortable: false
            },{
                field: "create_time", 
                title: "注册时间", 
                align: "center", 
                valign: "middle", 
                sortable: true
            },{
                field: "last_login_time",
                title: "最后在线时间",
                align: "center",
                valign: "middle",
                sortable: false
            },{
                field: "id",
                title: "操作",
                align: "center",
                valign: "middle",
                sortable: false,
                formatter: operateFormatter
           }],
            data: [{
                "user_login": "admin1",
                "title": 'admin1',
                "user_email": "admin1@admin.com",
                "create_time": "2015-11-05 15:45:22",
                "last_login_time": "2017-04-10 10:30:23"
            }],
            onLoadSuccess:function(data){
                    //console.log(data);
            },
            responseHandler:function(res) {
                var tem = {"total":0,"rows":[]};
                if(res.status){
                    tem.total = res.totalNum;
                    tem.rows = eval(res.data);
                }else{
                    $('#reportTable').bootstrapTable('removeAll');
                }
                return tem;
            },
            onLoadError:function(status,res){
                $('#reportTable').bootstrapTable('removeAll');
                console.log(status,res);
            },
        });

        $(window).resize(function () {
            $('#reportTable').bootstrapTable('resetView');
        });
        $("#kSearch").click(function(){
            var da1 = $('.date-range-picker').val();
            var username = $('.username').val();
            var usergroup = $(".usergroup").val();
            $('#reportTable').bootstrapTable('refresh');
        });
    });

</script>