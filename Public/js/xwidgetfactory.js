XWidgetTemplateFactory=(function(){var XWTF_UTIL={},toString=Object.prototype.toString;["Boolean","Number","String","Function","Array","Date","RegExp","Object"].forEach(function(name){var typevalue="[object "+name+"]";this["is"+name]=function(obj){return toString.call(obj)===typevalue;};},XWTF_UTIL);function XWidget(option){this._objs=option["objs"]||{};this._props=option["props"];}XWidget.prototype.get=XWidget.prototype.$=function(name){return name?this._objs[name]:this._objs;};XWidget.prototype.set=function(name,value){if(value==null){if(XWTF_UTIL.isObject(name)){this._objs=name;}else{if(XWTF_UTIL.isString(name)){delete this._objs[name];}}}else{if(name){this._objs[name]=value;}}};XWidget.prototype.getDom=function(){return this.get("widget_div");};XWidget.prototype.getProperty=function(name){return name?this._props.get(name):this._props;};XWidget.prototype.setProperty=function(name,value){if(value==null){if(!this._props&&name instanceof Map){this._props=name;}}else{if(name){if(!this._props){this._props=new Map();}this._props.put(name,value);}}};XWidget.prototype.dispose=function(){if(this.getComponent){this.getComponent().dispose();}var childcomponents=this.get("childcomponents");if(childcomponents){for(var i=0,len=childcomponents.length;i<len;i++){childcomponents.dispose();}}this._objs=null;this._props=null;};function XWidgetTemplate(xml){if(!xml||xml.nodeType!=1){throw new Error(I18N.getString("esmain.pagedesigner.js.xwidgetfactory.js.1","创建模版对象缺少模版XML节点."));}var prop=this._property={};prop[XWidgetTemplateFactory.TEMPLATE_XML_CONTENT]=xml;var dataRole=this.getProperty(XWidgetTemplateFactory.TEMPLATE_UIRENDER).getAttribute(PortalConstants.NAME_DATA_ROLE),commonprop=null;if(dataRole!==PortalConstants.VALUE_ROLE_GRID&&dataRole!==PortalConstants.VALUE_ROLE_CELL){dataRole=PortalConstants.VALUE_ROLE_WIDGET;commonprop=factoryInstance.getCommon(XWidgetTemplateFactory.TYPE_COMMON_WIDGET);}prop[PortalConstants.NAME_DATA_ROLE]=dataRole;prop[XWidgetTemplateFactory.TEMPLATE_COMMON_PROP]=commonprop||{};}var mergeXmlNode=(function(){function getNodeNames(node,value){var childNodes=node.childNodes,cNode=null,name=null;for(var i=0,len=childNodes.length;i<len;i++){cNode=childNodes[i];if(cNode.nodeType!=1){continue;}if(cNode.tagName=="pptedfolder"){getNodeNames(cNode,value);}else{name=cNode.getAttribute("name");if(name){value[name]=true;}}}}function insertChildNode(pNode,node,names){var childNodes=node.childNodes,cNode=null,nNode=null,nodeType=null;for(var i=0,len=childNodes.length;i<len;i++){cNode=childNodes[i];nodeType=cNode.nodeType;if(nodeType==4){pNode.appendChild(cNode.cloneNode(true));continue;}if(nodeType!=1){continue;}if(names[cNode.getAttribute("name")]){continue;}nNode=cNode.cloneNode(false);pNode.appendChild(nNode);insertChildNode(nNode,cNode,names);}}return function(node1,node2){if(!node1||!node2){return node1||node2||null;}var node=node2.cloneNode(true),names={};getNodeNames(node2,names);var childNodes=node1.childNodes,fNode=node.firstChild,cNode=null,nNode=null,nodeType=null;for(var i=0,len=childNodes.length;i<len;i++){cNode=childNodes[i];nodeType=cNode.nodeType;if(nodeType==4){node.insertBefore(cNode.cloneNode(true),fNode);continue;}if(nodeType!=1){continue;}if(names[cNode.getAttribute("name")]){continue;}nNode=cNode.cloneNode(false);node.insertBefore(nNode,fNode);insertChildNode(nNode,cNode,names);}var propName=PortalConstants.NAME_DATA_PROPERTY;var attr1=node1.getAttribute(propName),attr2=node2.getAttribute(propName);if(attr1){node.setAttribute(propName,attr2?attr1+";"+attr2:attr1);}return node;};})();var getCDATATrimValue=function(node){var content=getCDATASectionValue(node);return content?content.trim():null;};XWidgetTemplate.prototype.getProperty=function(name){var prop=this._property,p=prop[name];if(p===undefined){var node=prop[XWidgetTemplateFactory.TEMPLATE_XML_CONTENT];switch(name){case XWidgetTemplateFactory.TEMPLATE_WIDGET:var protoFunc=function(){};protoFunc.prototype=XWidget.prototype;var XWidgetTemp=function(option){XWidget.call(this,option);};XWidgetTemp.prototype=$.extend($.extend({constructor:XWidget},this.getProperty(XWidgetTemplateFactory.TEMPLATE_SCRIPT4METHODS)),new protoFunc);p=prop[name]=XWidgetTemp;break;case XWidgetTemplateFactory.TEMPLATE_UIRENDER:p=node.getElementsByTagName(name)[0];if(!p){throw new Error(I18N.getString("esmain.pagedesigner.js.xwidgetfactory.js.2","配置文件格式错误. 缺少ui-renderer配置项."));}var childNodes=p.childNodes;for(var i=0,len=childNodes.length;i<len;i++){if(childNodes[i].nodeType!=1){continue;}p=prop[name]=childNodes[i];break;}if(!p){throw new Error(I18N.getString("esmain.pagedesigner.js.xwidgetfactory.js.3","配置文件格式错误. ui-renderer配置项不能为空."));}break;case XWidgetTemplateFactory.TEMPLATE_EDITOR:p=node.getElementsByTagName(name)[0];if(p){try{var content=getCDATATrimValue(p),rt={};if(content){eval(content);}["type","node","ppt"].forEach(function(name){var value=p.getAttribute(name);if(value){rt[name]=value;}});p=rt;}catch(e){throw new Error(I18N.getString("esmain.pagedesigner.js.xwidgetfactory.js.4","配置文件格式错误.content-editor配置脚本不正确."),e);}}p=prop[name]=p||null;break;case XWidgetTemplateFactory.TEMPLATE_PROPERTY:p=prop[name]=mergeXmlNode(prop[XWidgetTemplateFactory.TEMPLATE_COMMON_PROP][name],node.getElementsByTagName(name)[0]);break;case XWidgetTemplateFactory.TEMPLATE_SCRIPT:p=node.getElementsByTagName(name)[0];if(p){try{p=getCDATATrimValue(p);if(p){p=eval("("+p+")");}}catch(e){throw new Error(I18N.getString("esmain.pagedesigner.js.xwidgetfactory.js.5","配置文件格式错误.script配置项不是正确的JSON格式."),e);}}p=prop[name]=p||{};break;case XWidgetTemplateFactory.TEMPLATE_SCRIPT4METHODS:case XWidgetTemplateFactory.TEMPLATE_SCRIPT4PROPERTY:case XWidgetTemplateFactory.TEMPLATE_SCRIPT4EVENTS:p=this.getProperty(XWidgetTemplateFactory.TEMPLATE_SCRIPT)[name];var commonscript=prop[XWidgetTemplateFactory.TEMPLATE_COMMON_PROP][XWidgetTemplateFactory.TEMPLATE_SCRIPT];if(commonscript){commonscript=commonscript[name];if(commonscript){p=$.extend({},commonscript,p);}}p=prop[name]=p||{};break;case XWidgetTemplateFactory.TEMPLATE_SCRIPT4ONPOPUPMENU:case XWidgetTemplateFactory.TEMPLATE_SCRIPT4ONSHOWPPT:p=this.getProperty(XWidgetTemplateFactory.TEMPLATE_SCRIPT)[name];if(!p){var commonscript=prop[XWidgetTemplateFactory.TEMPLATE_COMMON_PROP][XWidgetTemplateFactory.TEMPLATE_SCRIPT];if(commonscript){p=commonscript[name];}}p=prop[name]=p||null;break;case XWidgetTemplateFactory.TEMPLATE_STYLE:p=node.getElementsByTagName(name)[0]||null;if(p){p=getCDATATrimValue(p);if(p){addStyleSheet(p,"portaltemplate");}}p=prop[name]=p;break;case XWidgetTemplateFactory.TEMPLATE_MENU:var menuNode=node.getElementsByTagName(name)[0];if(menuNode){menuNode=menuNode.getElementsByTagName("menu")[0];}if(menuNode){var itemChild=getFirstChild(menuNode);if(itemChild){p=prop[XWidgetTemplateFactory.TEMPLATE_COMMON_PROP][XWidgetTemplateFactory.TEMPLATE_MENU].cloneNode(true);var idx=parseInt(menuNode.getAttribute("commonindex"))||1,item4insert=getFirstChild(p);while(item4insert&&idx--){item4insert=getNextElementSibling(item4insert);}var funcName=item4insert?"insertBefore":"appendChild";while(itemChild){p[funcName](itemChild.cloneNode(true),item4insert);itemChild=getNextElementSibling(itemChild);}}}p=prop[name]=p||null;break;default:throw new Error(I18N.getString("esmain.pagedesigner.js.xwidgetfactory.js.6","未知配置属性名【{0}】."),[name]);}}return p;};var factoryInstance=(function(){var fac_commonprops={};var fac_templates={};var fac_loadedtemplates={};var request=(function(){var ACTION="/esmain/portal/portalmgr.do";var callback=function(queryObj,opt){try{if(opt["onfinish"]){queryObj.checkResult();opt["onfinish"](queryObj.getResponseText(),opt["obj"]);}}catch(e){showError(e);}};return function(param,onfinish,obj){var map=new Map();for(var i in param){map.put(i,param[i]);}new QueryObj(ACTION,map,callback,{onfinish:onfinish,obj:obj});};})();var loadCommon=(function(){var doParseCommon=function(xml,callback){xml=xml.documentElement?xml.documentElement:xml;var childNodes=xml.childNodes,cNode=null,prop=null;for(var i=0,len=childNodes.length;i<len;i++){cNode=childNodes[i];if(cNode.nodeType!=1){continue;}prop=fac_commonprops[cNode.tagName.toLowerCase()]={};prop[XWidgetTemplateFactory.TEMPLATE_PROPERTY]=cNode.getElementsByTagName("properties-editor")[0];prop[XWidgetTemplateFactory.TEMPLATE_MENU]=cNode.getElementsByTagName("menu")[0];var scriptJson=cNode.getElementsByTagName("script")[0];if(scriptJson){try{scriptJson=getCDATATrimValue(scriptJson);if(scriptJson){scriptJson=eval("("+scriptJson+")");}}catch(e){throw new Error(I18N.getString("esmain.pagedesigner.js.xwidgetfactory.js.7","配置文件格式错误.script配置项不是正确的JSON格式.",e));}}prop[XWidgetTemplateFactory.TEMPLATE_SCRIPT]=scriptJson;}if(callback){callback();}};return isie?function(path,callback){parseXML(path,function(xml,callback){parseXML(xml.xml||xml,doParseCommon,callback);},callback);}:function(path,callback){parseXML(path,doParseCommon,callback);};})();var getCommon=function(id,name){switch(name){case XWidgetTemplateFactory.TEMPLATE_SCRIPT4METHODS:case XWidgetTemplateFactory.TEMPLATE_SCRIPT4PROPERTY:case XWidgetTemplateFactory.TEMPLATE_SCRIPT4EVENTS:case XWidgetTemplateFactory.TEMPLATE_SCRIPT4ONPOPUPMENU:case XWidgetTemplateFactory.TEMPLATE_SCRIPT4ONSHOWPPT:return getCommon(id,XWidgetTemplateFactory.TEMPLATE_SCRIPT)[name];default:var prop=fac_commonprops[id];if(!prop){return null;}return name?prop[name]:prop;}};var loadTemplate=(function(){var doLoad=function(data,opt){addTemplate(opt["id"],data,opt["callback"],opt["data"]);};return function(id,callback,data){if(checkWidgetExist(id,callback)){return;}request({id:id,command:"getWidget"},doLoad,{id:id,callback:callback,data:data});};})();var checkWidgetExist=function(id,callback,data){var widget=fac_templates[id];if(!widget){return false;}doCallback4widget(id,callback,widget,data);return true;};var doCallback4widget=function(id,callback,node,data){if(!callback){return;}var prop=node._property;if(prop){node=prop[XWidgetTemplateFactory.TEMPLATE_XML_CONTENT];}callback(id,node.getAttribute("name"),node.getAttribute("icon"),node.getAttribute("hint"),data);};var addTemplate=(function(){var doAdd=function(node,opt){var id=opt["id"],callback=opt["callback"];fac_templates[id]=new XWidgetTemplate(node);doCallback4widget(id,callback,node,opt["data"]);};return function(id,xml,callback,data){if(!id){return false;}if(checkWidgetExist(id,callback)){return;}parseXML(xml,doAdd,{id:id,callback:callback,data:data});};})();return{request:request,loadCommon:loadCommon,getCommon:getCommon,loadTemplate:loadTemplate,addTemplate:addTemplate,removeTemplate:function(id){delete fac_templates[id];},getTemplate:function(id){var template=fac_templates[id];if(!fac_loadedtemplates[id]){try{template.getProperty(XWidgetTemplateFactory.TEMPLATE_STYLE);var evts=template.getProperty(XWidgetTemplateFactory.TEMPLATE_SCRIPT4EVENTS);if(evts&&evts["onload"]){evts["onload"](template);}}catch(e){}fac_loadedtemplates[id]=true;}return template;}};})();return{TYPE_COMMON_PAGE:"page",TYPE_COMMON_GRID:"container-grid",TYPE_COMMON_CELL:"container-cell",TYPE_COMMON_WIDGET:"widget",TYPE_COMMON_WIDGETS:"widgets",TEMPLATE_COMMON_PROP:"commonprop",TEMPLATE_WIDGET:"widget",TEMPLATE_XML_CONTENT:"xmlcontent",TEMPLATE_UIRENDER:"ui-renderer",TEMPLATE_EDITOR:"content-editor",TEMPLATE_PROPERTY:"properties-editor",TEMPLATE_SCRIPT:"script",TEMPLATE_SCRIPT4METHODS:"methods",TEMPLATE_SCRIPT4PROPERTY:"propertychanges",TEMPLATE_SCRIPT4EVENTS:"events",TEMPLATE_SCRIPT4ONPOPUPMENU:"onpopup4menu",TEMPLATE_SCRIPT4ONSHOWPPT:"onshowppt",TEMPLATE_STYLE:"style",TEMPLATE_MENU:"contextmenu",getInstance:function(){return factoryInstance;}};})();XWidgetFactory=(function(){var a={};var c={};var d={};var b={dispose:function(){for(var e in c){c[e].dispose();}c=null;a=null;},addWidgetHandler:function(f,e){if(f&&e instanceof WidgetHandler){a[f]=e;}},getWidgetHandler:function(e){return a[e]||a[PortalConstants.VALUE_ROLE_WIDGET];},addWidgetEditor:function(f,e){if(!f||!e){return;}if(e instanceof XWidgetEditor){c[f]=e;}else{if(e["cls"]){d[f]=e;}}},getWidgetEditor:function(f){var e=c[f];if(!e){e=d[f];if(e){e=c[f]=new e["cls"](e["args"]);d[f]=null;}else{e=c[PortalConstants.TYPE_EDITOR_NONE];if(!e){e=c[PortalConstants.TYPE_EDITOR_NONE]=new XWidgetEditor();}}}return e;},createWidget:function(i,f){var g=XWidgetTemplateFactory.getInstance().getTemplate(i);if(!g){throw new Error(I18N.getString("esmain.pagedesigner.js.xwidgetfactory.js.templatenotexit","组件模版【{0}】不存在,创建组件失败.",[i]));}var e=g.getProperty(XWidgetTemplateFactory.TEMPLATE_UIRENDER);var h=this.getWidgetHandler(e.getAttribute(PortalConstants.NAME_DATA_ROLE)).create(e,f);return new (g.getProperty(XWidgetTemplateFactory.TEMPLATE_WIDGET))({objs:h});}};return{save:function(g,e,f){b.getWidgetHandler(e.getAttribute(PortalConstants.NAME_DATA_ROLE)).save(g,e,f||0);},load:function(e,f){var g=b.getWidgetHandler(e.getAttribute(PortalConstants.NAME_DATA_ROLE));return g.load.apply(g,arguments);},getInstance:function(){return b;}};})();